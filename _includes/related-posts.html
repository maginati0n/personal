{% comment %}
Automatic Related Posts Generator - Smart version that avoids duplication with prev/next navigation
{% endcomment %}

{% assign related_posts = site.posts | where_exp: "post", "post.url != page.url" %}
{% assign related_by_tags = "" | split: "" %}

{% comment %} Exclude prev/next posts to avoid duplication {% endcomment %}
{% assign excluded_posts = "" | split: "" %}
{% if page.previous %}
  {% assign excluded_posts = excluded_posts | push: page.previous.url %}
{% endif %}
{% if page.next %}
  {% assign excluded_posts = excluded_posts | push: page.next.url %}
{% endif %}

{% comment %} Find posts with shared tags, excluding prev/next {% endcomment %}
{% for post in related_posts %}
  {% unless excluded_posts contains post.url %}
    {% assign shared_tags = 0 %}
    {% for tag in post.tags %}
      {% if page.tags contains tag %}
        {% assign shared_tags = shared_tags | plus: 1 %}
      {% endif %}
    {% endfor %}
    
    {% if shared_tags > 0 %}
      {% assign post_with_score = post.url | append: "|" | append: shared_tags %}
      {% assign related_by_tags = related_by_tags | push: post_with_score %}
    {% endif %}
  {% endunless %}
{% endfor %}

{% comment %} Sort by shared tags and limit to 3 {% endcomment %}
{% assign sorted_related = related_by_tags | sort_natural | reverse | slice: 0, 3 %}

{% if sorted_related.size > 0 %}
<div class="related-posts">
  <h3>Related Articles</h3>
  <div class="related-posts-grid">
    {% for item in sorted_related %}
      {% assign post_data = item | split: "|" %}
      {% assign post_url = post_data[0] %}
      
      {% for post in site.posts %}
        {% if post.url == post_url %}
          <article class="related-post-item">
            <h4><a href="{{ post.url }}">{{ post.title }}</a></h4>
            <p class="related-post-excerpt">{{ post.description | default: post.excerpt | strip_html | truncate: 120 }}</p>
            <div class="related-post-meta">
              <span class="post-date">{{ post.date | date: "%b %d, %Y" }}</span>
              {% if post.tags.size > 0 %}
                <span class="post-tags">
                  {% for tag in post.tags limit: 2 %}
                    <span class="tag">{{ tag }}</span>
                  {% endfor %}
                </span>
              {% endif %}
            </div>
          </article>
          {% break %}
        {% endif %}
      {% endfor %}
    {% endfor %}
  </div>
  
  <p class="related-posts-cta">
    <em>Explore more <a href="/tags/">topics</a> or browse the <a href="/archive/">complete archive</a>.</em>
  </p>
</div>
{% endif %}